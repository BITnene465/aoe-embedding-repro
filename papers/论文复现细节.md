# AnglE 论文实验细节笔记

基于对 AnglE 论文 (Li et al., 2023) 及官方代码库的调研，总结其训练流程与实验细节如下。

## 1. 核心训练流程 (Two-Stage Training)

AnglE 的训练通常分为两个阶段：**NLI 预训练** 和 **STS 微调**。

### 第一阶段：NLI 预训练 (Pre-training on NLI)
这是 AnglE 获得通用语义表示能力的关键阶段。
*   **数据**: SNLI + MultiNLI (约 275k + 392k 样本)。
*   **目标**: 让模型学习基础的蕴含/矛盾关系。
*   **损失函数**:
    *   **Angle Loss (`L_angle`)**: 核心创新点，在复数空间优化角度差异。
    *   **Contrastive Loss (`L_cl`)**: 传统的对比学习损失（如 InfoNCE）。
    *   **权重**: 通常给予 `L_cl` 较大的权重（如 30.0），`L_angle` 权重为 1.0。
*   **超参数**:
    *   Batch Size: 较大（如 256 或 512，通过梯度累积实现）。
    *   Learning Rate: 2e-5 ~ 5e-5。

### 第二阶段：STS 微调 (Fine-tuning on STS)
为了在特定任务（如 STS Benchmark）上达到 SOTA，会在预训练模型基础上进行微调。
*   **数据**: STS-B 训练集 (约 5.7k 样本)。
*   **目标**: 进一步对齐余弦相似度（或角度相似度）与人类评分。
*   **损失函数**:
    *   **Angle Loss (`L_angle`)**: 权重通常较小（如 0.02）。
    *   **Contrastive Loss (`L_cl`)**: 权重通常为 1.0。
    *   **In-Batch Negative (`L_ibn`)**: 利用批次内其他样本作为负例。
    *   **Cosine Loss (`L_cos`)**: 官方代码默认为 0.0（即不使用 MSE 逼近 Cosine，而是依赖 Angle/CL 优化排序）。
*   **超参数**:
    *   Batch Size: 相对较小（如 64）。
    *   Epochs: 较多（如 10）。

## 2. 数据集处理细节

### 训练集 (Training Sets)
*   **NLI**: 用于预训练。格式通常为 `(premise, hypothesis, label)`，其中 `entailment` 为正例，`contradiction` 为负例。
*   **STS-B (Train)**: 用于微调。格式为 `(sent1, sent2, score)`。

### 评估集 (Evaluation Sets)
以下数据集通常**仅用于评估 (Zero-shot Evaluation)**，不参与训练：
*   **STS12 ~ STS16**: SemEval 历年的 STS 任务数据集。
*   **SICK-R**: Sentences Involving Compositional Knowledge (Relatedness)。
*   **STS-B (Dev/Test)**: 用于验证模型效果。
*   **GIS (GitHub Issue Similarity)**: AnglE 论文提出的**长文本 STS 数据集**。
    *   **来源**: 收集自 GitHub Issues，将重复的 Issue 视为正例，非重复的视为负例。
    *   **用途**: 专门用于评估模型在**长文本**场景下的语义相似度匹配能力。

**注意**: 在复现实验中，我们应遵循 "Train on STS-B Train -> Evaluate on All" 的原则，而不是将所有 STS 数据混合训练。

## 3. 关键超参数总结

| 参数 | NLI 预训练 | STS 微调 | 说明 |
| :--- | :--- | :--- | :--- |
| `w_angle` | 1.0 | 0.02 | Angle Loss 权重 |
| `w_cl` | 30.0 | 1.0 | Contrastive Loss 权重 |
| `angle_tau` | 20.0 | 20.0 | Angle Loss 温度系数 |
| `cl_scale` | 20.0 | 20.0 | Contrastive Loss 温度系数 |
| `pooling` | `cls` | `cls` | 均使用 CLS token |

## 4. 结论与复现建议

1.  **复现路径**: 优先完成 NLI 预训练，这是 AnglE 效果的基础。
2.  **微调策略**: 使用 `scripts/finetune_task.sh` 对 STS-B 进行单独微调。
3.  **评估方式**: 使用 `python -m aoe.eval_sts --tasks all` 对所有 STS 任务进行评估。
4.  **Loss 设置**: 保持 `w_cosine=0.0`，不要引入额外的 MSE Loss，以免破坏 AnglE 的优化目标。
